# **AI智能定时任务插件**

这是一个智能定时任务插件，它可以帮助用户设置智能化的定时提醒和自动执行任务，并支持与AI进行自然语言交互。

## **功能特点**

* 支持设置一次性或重复性的定时提醒。  
* 支持设置自动执行任务，到时间后AI会自动执行指定操作。  
* 支持调用其他LLM函数，实现更复杂的自动化任务。  
* AI智能化提醒，生成自然语言的提醒内容。  
* 支持多种重复模式：每天、每周、每月、每年。  
* 支持法定节假日判断，可设置仅在工作日或节假日触发的提醒和任务。  
* 支持会话隔离，群聊中每个成员可以有独立的提醒和任务。  
* 支持通过配置文件设置全员定时提醒。  
* 支持PostgreSQL数据库存储，适合大规模部署。
* 简单的命令管理系统。  
* 持久化存储提醒和任务数据。

## **安装方法**

1. 将插件文件夹 `plugin_remind` 复制到 主程序 的 plugins 目录下
2. 重启 主程序

## **使用方法**

### **设置提醒**

插件会注册为AI工具，可以直接用自然语言设置提醒，例如：

* "帮我设置一个提醒，明天早上8点提醒我去上班"  
* "每天晚上10点提醒我睡觉"  
* "每个工作日早上8点提醒我打卡"

### **设置任务**

除了提醒外，还可以设置任务，让AI在指定时间自动执行操作：

* "设置一个任务，明天早上8点发送今日天气预报"  
* "每天中午12点帮我汇总今日新闻"  
* "每个天下午5点提醒所有人下班，工作日触发"  
* "帮我删了之前布置的开会任务"

### **命令列表**

插件提供以下命令用于管理提醒和任务：

1. 添加提醒：  
   /si 添加提醒 <内容> <时间> [星期] [重复类型] [节假日类型]  
   * 例如：/si 添加提醒 写周报 8:05 mon weekly  
   * 例如：/si 添加提醒 上班打卡 8:30 daily workday（每个工作日）  
   * 例如：/si 添加提醒 休息提醒 9:00 daily holiday（每个法定节假日）  
2. 添加任务：  
   /si 添加任务 <内容> <时间> [星期] [重复类型] [节假日类型]  
   * 例如：/si 添加任务 发送天气预报 8:00 daily  
   * 例如：/si 添加任务 工作安排 9:00 mon weekly workday（每周一工作日）  
3. 查看所有提醒和任务：  
   /si 列表  
4. 删除指定提醒或任务：  
   /si 删除 <序号>  
   * 例如：删除第1个提醒 /si 删除 1  
5. 查看帮助信息：  
   /si 帮助

## **数据存储选项**

插件支持两种数据存储方式：JSON文件（默认）和PostgreSQL数据库。

### **JSON文件存储（默认）**

默认情况下，提醒和任务数据会存储在本地JSON文件中。

* 路径：data/remind_data/remind_data.json

### **PostgreSQL数据库存储**

对于需要更高可靠性或多实例部署的场景，插件支持使用PostgreSQL数据库存储数据。

#### **如何启用PostgreSQL存储**

有两种方式可以配置PostgreSQL连接：

1. **通过环境变量**：
   ```bash
   export POSTGRES_URL="postgresql://用户名:密码@主机:端口/数据库名"
   ```

2. **通过插件配置**：
   在插件配置中设置`postgres_url`字段，格式为：
   ```
   postgresql://用户名:密码@主机:端口/数据库名
   ```

#### **数据库结构**

插件会自动创建所需的表结构，主要包含以下表：

* `reminders`：存储提醒和任务数据

## **全员定时提醒功能**

可以通过插件配置文件为机器人所加入的所有群聊设置全局定时提醒。

### **如何配置全员提醒？**

1. 找到插件的配置文件。  
2. 在该JSON文件中，添加或修改 all_user_reminds 字段。  
3. 这是一个**对象数组**，每个对象代表一个独立的提醒配置，可以包含更复杂的规则。

#### **配置项说明**

每个提醒对象可以包含以下字段：

* content (string): 提醒的具体内容。  
* time (string): 提醒时间，格式必须为 "HH:MM"。  
* repeat_type (string): 重复类型，决定提醒的重复周期。  
  * "daily": 每天  
  * "weekly": 每周  
  * "monthly": 每月  
  * "yearly": 每年  
* holiday_type (string): 节假日触发类型，可以与 repeat_type 结合使用，实现更灵活的提醒。  
  * "none": 默认值，不关心当天是否为节假日，按 repeat_type 规则正常提醒。  
  * "workday": 仅在工作日触发提醒。  
  * "holiday": 仅在法定节假日触发提醒。

### **配置示例**

下面是一个完整的 all_user_reminds 配置示例，其中包含两个全员提醒：

```json
{  
    "all_user_reminds": [  
      {  
        "content": "上班打卡提醒",  
        "date_time": "08:30",  
        "repeat_type": "daily",  
        "holiday_type": "workday"  
      },  
      {  
        "content": "下班提醒，记得今天的事情做完了吗？",  
        "date_time": "18:00",  
        "repeat_type": "daily",  
        "holiday_type": "workday"  
      },  
      {  
        "content": "记得喝水哦",  
        "date_time": "10:00",  
        "repeat_type": "daily",  
        "holiday_type": "none"  
      }  
    ]  
}
```

**重要提示**：修改配置文件后，需要**重启 主程序** 才能使新的全员提醒设置生效。

## **会话隔离功能**

### **什么是会话隔离？**

会话隔离功能使群聊中的每个成员都能拥有自己独立的提醒和任务列表，其他成员无法看到或操作。

* **关闭状态**：群聊中所有成员共享同一组提醒和任务列表。  
* **开启状态**：群聊中每个成员都有自己独立的提醒和任务列表。

### **如何启用会话隔离？**

会话隔离功能默认关闭，可以通过管理面板的插件配置开启：

1. 进入主程序管理面板。  
2. 找到"插件管理"->"本插件"。  
3. 点击"配置"按钮。  
4. 将"启用会话隔离"选项勾选，然后保存。

## **配置说明**

* **个人/群组提醒数据**：
  * JSON模式：插件会在 data/remind_data目录下自动创建 remind_data.json 文件用于存储用户创建的提醒和任务数据。
  * PostgreSQL模式：数据存储在数据库的reminders表中。  
* **插件核心配置**：  
  * unique_session: (布尔值) 是否开启会话隔离。
  * postgres_url: (字符串) PostgreSQL连接字符串，留空则使用JSON文件存储。
  * all_user_reminds: (数组) 全员定时提醒列表。  
* **法定节假日数据**：会缓存在 data/holiday_data/holiday_cache.json 文件中，缓存期为30天，过期后会自动更新。

## **提醒与任务的区别**

* **提醒**：到时间后会提醒用户做某事，例如"提醒我去开会"。  
* **任务**：到时间后AI会自动执行指定的操作，例如"发送天气预报"或"调用某个函数"。

## **依赖要求**

* 主程序 框架
* APScheduler
* aiohttp
* asyncpg

## **作者**

* 作者：beat4ocean  
* 版本：v0.0.2